# Release Notes v5.10.0

## Highlights

-   **Moon Phase Details Factory**: New `MoonPhaseDetailsFactory` computes detailed lunar phase data â€” exact phase times (1-second precision via Swiss Ephemeris binary search), illumination, eclipses, sunrise/sunset, and zodiac positions.
-   **AI Context Serializer XML Migration**: **Breaking change** â€” `to_context()` and all `*_to_context()` functions now produce well-formed XML instead of plain text. Semantic tags, proper escaping via `xml.sax.saxutils`, and optional field omission.
-   **Moon Phase Overview Report**: New `"moon_phase_overview"` report kind in `ReportGenerator` for human-readable moon phase output.
-   **2042 Historical Verification Tests**: Moon phase calculations verified against AstroPixels reference data (2001â€“2040).

## Breaking Changes

### Context Serializer XML Output

The `to_context()` function now returns XML. If you were parsing the plain-text output, you will need to update your code.

**Before (v5.9.0 and earlier):**

```text
Chart for Alice
Birth data: 1990-01-01 12:00, London, GB
Celestial Points:
  - Sun at 10.81Â° in Capricorn in Tenth House, quality: Cardinal, element: Earth...
```

**After (v5.10.0):**

```xml
<chart name="Alice">
  <birth_data date="1990-01-01" time="12:00" city="London" nation="GB" ... />
  <config zodiac="Tropical" house_system="Placidus" perspective="Apparent Geocentric" />
  <planets>
    <point name="Sun" position="10.81" sign="Capricorn" element="Earth" quality="Cardinal" house="Tenth House" motion="direct" speed="1.02" />
    ...
  </planets>
  <houses>...</houses>
  <lunar_phase name="Waning Gibbous" phase="20" degrees_between="254.32" emoji="ðŸŒ–" />
</chart>
```

Key XML design decisions:

-   Self-closing tags for atomic data: `<point ... />`, `<aspect ... />`, `<lunar_phase ... />`
-   Nested tags for structured data: `<chart>`, `<chart_analysis>`, `<moon_phase_overview>`
-   `None`/optional fields are **omitted** (tag not present), not rendered as empty
-   Non-qualitative: no interpretive words like "good", "bad", "strong", "weak"
-   All values escaped via `xml.sax.saxutils.escape` and `quoteattr`

## New Features

### MoonPhaseDetailsFactory

A new factory class that computes detailed moon phase information from an `AstrologicalSubjectModel`:

-   Exact times of upcoming and previous New Moon, First Quarter, Full Moon, and Last Quarter (Swiss Ephemeris binary search, 1-second precision)
-   Illumination percentage, waxing/waning stage, moon age, lunar cycle progress
-   Next lunar and solar eclipses
-   Sunrise, sunset, solar noon, day length
-   Sun and Moon zodiac sign positions

```python
from kerykeion import AstrologicalSubjectFactory, MoonPhaseDetailsFactory

subject = AstrologicalSubjectFactory.from_birth_data(
    "Alice", 1990, 1, 1, 12, 0, "London", "GB"
)
overview = MoonPhaseDetailsFactory.from_subject(subject)

print(overview.moon.phase_name)       # "Waxing Crescent"
print(overview.moon.illumination)     # "15%"
print(overview.moon.age_days)         # 4
print(overview.moon.zodiac.sign)      # "Pisces"
```

### MoonPhaseOverviewModel Report

A new report kind in `ReportGenerator` renders moon phase details as a human-readable text report:

```python
from kerykeion import ReportGenerator

report = ReportGenerator(overview)
report.print_report()
```

Sections include: Moon Summary, Illumination Details, Upcoming Phases, Next Lunar Eclipse, Sun Info, Next Solar Eclipse, and Location.

### Moon Phase Overview XML Serialization

New `moon_phase_overview_to_context()` function with full support for all nested fields:

```python
from kerykeion import to_context

xml = to_context(overview)
# <moon_phase_overview timestamp="..." datestamp="...">
#   <moon>
#     <phase_name>Waxing Crescent</phase_name>
#     <illumination>15%</illumination>
#     ...
#   </moon>
# </moon_phase_overview>
```

## Bug Fixes

-   **House cusp sign abbreviation**: `"Ari"` now correctly rendered as `"Aries"` in context serializer output via `SIGN_FULL_NAMES` mapping.
-   **`llms.txt` import example**: Added missing `AstrologicalSubjectFactory`, `ChartDataFactory` imports.
-   **`ReportGenerator` crash**: Fixed crash when `_primary_subject` is `None` (added defensive `assert` guards).
-   **`RelationshipScoreFactory` README snippet**: Fixed wrong method name and field names in code example.
-   **Docs frontmatter collision**: Fixed ordering collision between `transits_time_range_factory.md` and `ephemeris_data_factory.md`.

## Testing

-   **2042 historical verification tests** against AstroPixels reference data (2001â€“2040), covering angle accuracy, phase names, emojis, major phases, illumination, waxing/waning stage, upcoming phases, eclipse predictions, synodic month bounds, and 28-phase boundary mapping.
-   **54 mocked unit tests** for `MoonPhaseDetailsFactory` (helper functions, full `from_subject()` with mocked Swiss Ephemeris layer, null/failure edge cases, phase angle boundary tests).
-   **21 report tests** with golden snapshot fixture for moon phase overview.
-   **Rewrote all context serializer test assertions** for XML format (84 test methods across 19 classes).
-   **17 tests** for `MoonPhaseOverviewToContext` covering all nested branches.
-   Extended `TestNonQualitativeOutput` to verify subject, natal chart, synastry chart, and moon phase overview outputs.

## Documentation

-   Added `moon_phase_details_factory.md` documentation page with API reference and examples.
-   Added `moon-phase-details.md` examples page.
-   Updated `context_serializer.md` with XML format documentation and examples.
-   Updated `README.md` with Moon Phase Details section and XML output examples.
-   Updated `llms.txt` to document XML output format.
-   Updated `report.md` with Moon Phase Overview Report section.

## Upgrade Path

**This release contains a breaking change.** If you use `to_context()` and parse its output as plain text, you must update your parsing logic to handle XML. The function signature and supported model types are unchanged â€” only the output format has changed from plain text to XML.

If you do not use `to_context()`, this release is fully backward compatible with v5.9.x.

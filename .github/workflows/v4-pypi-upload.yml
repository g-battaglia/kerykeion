name: Publish Kerykeion 💫 to PyPI 📦

on:
  push:
    branches:
      - dev-v4
    # tags:
    #  - "v*"

jobs:
  test:
    name: Test all changes 💫
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install poetry
        run: >-
          python -m
          pip install
          poetry
          --user

      - name: Install packages
        run: >-
          poetry
          install

      - name: Run the test
        run: >-
          poetry
          run
          pytest

  build-n-publish:
    name: Build and publish Python 🐍 distributions 📦 to PyPI
    needs: [test]
    if: |
      ${{ always() && (needs.test.result == 'success') }} &&
      # prevents this action from running on forks
      github.repository == 'g-battaglia/kerykeion'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install poetry
        run: >-
          python -m
          pip install
          poetry
          --user

      - name: Define test-pypi
        run: >-
          python -m
          poetry config 
          repositories.test-pypi 
          https://test.pypi.org/legacy/

      - name: Publish to PYPI
        run: >-
          python -m
          poetry publish
          --build 
          -r test-pypi
          --username __token__
          --password ${{ secrets.TEST_PYPI_API_TOKEN }}

